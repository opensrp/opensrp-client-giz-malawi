package org.smartregister.giz.configuration;

import android.content.Intent;

import com.vijay.jsonwizard.utils.FormUtils;

import org.json.JSONException;
import org.json.JSONObject;
import org.junit.After;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.MockitoAnnotations;
import org.powermock.reflect.Whitebox;
import org.robolectric.util.ReflectionHelpers;
import org.smartregister.Context;
import org.smartregister.CoreLibrary;
import org.smartregister.clientandeventmodel.Event;
import org.smartregister.domain.UniqueId;
import org.smartregister.giz.BaseRobolectricTest;
import org.smartregister.maternity.MaternityLibrary;
import org.smartregister.maternity.configuration.MaternityOutcomeFormProcessingTask;
import org.smartregister.maternity.pojo.MaternityEventClient;
import org.smartregister.maternity.utils.AppExecutors;
import org.smartregister.maternity.utils.MaternityConstants;
import org.smartregister.repository.AllSharedPreferences;
import org.smartregister.repository.UniqueIdRepository;

import java.util.HashMap;
import java.util.List;

public class GizMaternityOutcomeFormProcessingTest extends BaseRobolectricTest {
    private String outcomeForm = "{\"count\":\"5\",\"encounter_type\":\"Maternity Outcome\",\"entity_id\":\"\",\"metadata\":{\"start\":{\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_data_type\":\"start\",\"openmrs_entity_id\":\"163137AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"end\":{\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_data_type\":\"end\",\"openmrs_entity_id\":\"163138AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"today\":{\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"encounter\",\"openmrs_entity_id\":\"encounter_date\"},\"deviceid\":{\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_data_type\":\"deviceid\",\"openmrs_entity_id\":\"163149AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"subscriberid\":{\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_data_type\":\"subscriberid\",\"openmrs_entity_id\":\"163150AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"simserial\":{\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_data_type\":\"simserial\",\"openmrs_entity_id\":\"163151AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"phonenumber\":{\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_data_type\":\"phonenumber\",\"openmrs_entity_id\":\"163152AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"encounter_location\":\"\",\"look_up\":{\"entity_id\":\"\",\"value\":\"\"}},\"step1\":{\"title\":\"HIV Status & Treatment\",\"next\":\"step2\",\"fields\":[{\"key\":\"hiv_status_previous\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Previous HIV Status\",\"values\":[\"Positive\",\"Negative\",\"Unknown\"],\"openmrs_choice_ids\":{\"Positive\":\"138571AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Negative\":\"664AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Unknown\":\"1138AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"v_required\":{\"value\":\"true\",\"err\":\"Kindly select the woman's previous HIV Status\"}},{\"key\":\"hiv_status_current\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"spinner\",\"hint\":\"Current HIV Status\",\"values\":[\"Positive\",\"Negative\",\"Unknown\"],\"openmrs_choice_ids\":{\"Positive\":\"138571AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Negative\":\"664AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Unknown\":\"1138AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"v_required\":{\"value\":\"true\",\"err\":\"Kindly select the woman's current HIV Status\"}},{\"key\":\"on_art_treatment\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Is woman on ART treatment?\",\"relevance\":{\"rules-engine\":{\"ex-rules\":{\"rules-file\":\"maternity/outcome_relevance_rules.yml\"}}},\"values\":[\"Yes\",\"No\"],\"openmrs_choice_ids\":{\"Yes\":\"1065AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"No\":\"1066AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"}},{\"key\":\"art_clinic_number\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"ART Clinic Number\",\"relevance\":{\"step1:on_art_treatment\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"hiv_treatment_start\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"ART Mother treatment start period\",\"values\":[\"On ART before pregnancy\",\"1st and 2nd Trimester(0-27 weeks)\",\"3rd Trimester(28+)\",\"During Labour\"],\"keys\":[\"On ART before pregnancy\",\"1st and 2nd Trimester(0-27 weeks)\",\"3rd Trimester(28+)\",\"During Labour\"],\"relevance\":{\"step1:on_art_treatment\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"not_art_reason\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Why is the woman not on ART?\",\"relevance\":{\"step1:on_art_treatment\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"No\\\")\"}},\"values\":[\"Defaulted\",\"Not Started on ART\",\"Other (Specify)\"],\"keys\":[\"Defaulted\",\"Not Started on ART\",\"Other (Specify)\"]},{\"key\":\"not_art_reason_other\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"Specify\",\"relevance\":{\"step1:not_art_reason\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Other (Specify)\\\")\"}}},{\"key\":\"mother_tdv_doses\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"label_info_text\":\"Whether the child's mother received 2 or more doses of TdV, which transfers protection against Td to the child when they're born.\",\"hint\":\"How many doses of TdV did the mother receive?\",\"v_required\":{\"value\":true,\"err\":\"Please choose an option\"},\"values\":[\"5 TDV doses received\",\"2 - 4 TDV doses received in the past\",\"1 TDV received\",\"TDV not received\",\"Unknown\"],\"keys\":[\"5\",\"2_4\",\"1\",\"none\",\"unknown\"]},{\"key\":\"protected_at_birth\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"164826AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"spinner\",\"label_info_text\":\"Whether the child's mother received 2+ doses of Td.\",\"hint\":\"Protected at birth (PAB)\",\"entity_id\":\"mother\",\"v_required\":{\"value\":true,\"err\":\"Please choose an option\"},\"values\":[\"Yes\",\"No\",\"Don't Know\"],\"openmrs_choice_ids\":{\"Yes\":\"1065AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"No\":\"1066AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Don't Know\":\"1067AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"relevance\":{\"step1:mother_tdv_doses\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"5\\\")\"}}}]},\"step2\":{\"title\":\"Delivery Details\",\"next\":\"step3\",\"fields\":[{\"key\":\"delivery_date\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"5599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"date_picker\",\"hint\":\"Date of delivery\",\"min_date\":\"today-3y\",\"max_date\":\"today\",\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the date of delivery\"}},{\"key\":\"delivery_place\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"1572AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"spinner\",\"hint\":\"Place of delivery\",\"values\":[\"This Facility\",\"In-Transit (TR)\",\"Other Facility\",\"Home/Traditional Birth Authority(CMA)\"],\"openmrs_choice_ids\":{\"This Facility\":\"159372AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"In-Transit (TR)\":\"1601AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Other Facility\":\"1588AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Home/Traditional Birth Authority(CMA)\":\"1536AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the place of delivery\"}},{\"key\":\"delivery_person\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"1573AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"spinner\",\"hint\":\"Staff conducting the delivery\",\"values\":[\"Medical Doctor (MD)\",\"Clinical Officer (CO)\",\"Medical Assistant (MA)\",\"Nurse Midwife\",\"Community Midwifery Assistant (CMA)\",\"Other (Specify)\"],\"openmrs_choice_ids\":{\"Medical Doctor (MD)\":\"1574AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Clinical Officer (CO)\":\"1574AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Nurse Midwife\":\"1577AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Community Midwifery Assistant (CMA)\":\"1578AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Other (Specify)\":\"5622AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"v_required\":{\"value\":\"true\",\"err\":\"Please select the staff conducting the delivery\"}},{\"key\":\"delivery_person_other\",\"openmrs_entity_parent\":\"1573AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"edit_text\",\"hint\":\"Specify\",\"relevance\":{\"step2:delivery_person\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Other (Specify)\\\")\"}}},{\"key\":\"delivery_mode\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"5630AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"spinner\",\"hint\":\"Mode of delivery\",\"values\":[\"Vaginal Birth\",\"Spontan Vertex(SVD)\",\"Vacuum Extraction(VE)\",\"Breech (BR)\",\"Caesar Section (CS)\",\"Other (Specify)\"],\"openmrs_choice_ids\":{\"Vaginal Birth\":\"162595AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Spontaneous Vertex (SVD)\":\"158865AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Vacuum Extraction (VE)\":\"159260AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Breech (BR)\":\"1172AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Caesarean Section (CS)\":\"1171AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Other (Specify)\":\"5622AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"v_required\":{\"value\":\"true\",\"err\":\"Please select the delivery mode\"}},{\"key\":\"delivery_mode_other\",\"openmrs_entity_parent\":\"5630AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"edit_text\",\"hint\":\"Specify\",\"relevance\":{\"step2:delivery_mode\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Other (Specify)\\\")\"}}}]},\"step3\":{\"title\":\"Babies born\",\"next\":\"step4\",\"fields\":[{\"key\":\"babies_born\",\"type\":\"repeating_group\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"reference_edit_text_hint\":\"#Total live babies born\",\"repeating_group_label\":\"Baby Born Alive\",\"reference_edit_text\":\"Number of babies born alive\",\"value\":[{\"key\":\"discharged_alive\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Was the baby discharged alive?\",\"values\":[\"Yes\",\"No\"],\"keys\":[\"Yes\",\"No\"],\"v_required\":{\"value\":\"true\",\"err\":\"Select whether the baby was discharged alive\"}},{\"key\":\"baby_first_name\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"First name\",\"edit_type\":\"name\",\"v_regex\":{\"value\":\"^[A-Za-z0-9_]+$\",\"err\":\"Please enter a valid name\"},\"v_required\":{\"value\":true,\"err\":\"Please enter a first name\"},\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"baby_last_name\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"Last name\",\"edit_type\":\"name\",\"v_required\":{\"value\":true,\"err\":\"Please enter the last name\"},\"v_regex\":{\"value\":\"[A-Za-z\\\\s\\\\.\\\\-]*\",\"err\":\"Please enter a valid name\"},\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"baby_dob\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"date_picker\",\"hint\":\"Birth date\",\"max_date\":\"today\",\"expanded\":false,\"v_required\":{\"value\":\"true\",\"err\":\"Enter the birth time and date of the child\"},\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"baby_gender\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Child's gender\",\"values\":[\"Male\",\"Female\"],\"keys\":[\"Male\",\"Female\"],\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the Gender of the child\"},\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"birth_weight_entered\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"Birth Weight(gm)\",\"v_numeric_integer\":{\"value\":\"true\",\"err\":\"Enter a valid weight\"},\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the child's birth weight\"},\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"birth_height_entered\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"Birth Height(cm)\",\"v_numeric_integer\":{\"value\":\"true\",\"err\":\"Enter a valid height\"},\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the child's birth height\"},\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"apgar\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"APGAR score\",\"v_numeric_integer\":{\"value\":\"true\",\"err\":\"Enter a valid APGAR score\"},\"v_min\":{\"err\":\"The APGAR score should be greater than 0\",\"value\":\"1\"},\"v_max\":{\"err\":\"The APGAR score should be 10 or less than 10\",\"value\":\"10\"},\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the child's birth APGAR\"},\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"baby_first_cry\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Did the baby cry at birth?\",\"values\":[\"Yes\",\"No\"],\"keys\":[\"Yes\",\"No\"],\"v_required\":{\"value\":\"true\",\"err\":\"Kindly select whether the baby cried at birth\"},\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"newborn_care_complications_label\",\"type\":\"label\",\"text\":\"Newborn Care\",\"has_bg\":false,\"top_padding\":\"10dp\",\"left_padding\":\"20dp\",\"right_padding\":\"20dp\",\"text_size\":\"14sp\",\"text_color\":\"#000000\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"baby_complications\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"check_box\",\"label\":\"Newborn Care Complications\",\"combine_checkbox_option_values\":\"true\",\"exclusive\":[\"none\"],\"options\":[{\"key\":\"none\",\"text\":\"None\"},{\"key\":\"premature\",\"text\":\"Premature\"},{\"key\":\"asphyxia\",\"text\":\"Asphyxia\"},{\"key\":\"sepsis\",\"text\":\"Sepsis\"},{\"key\":\"birth_defects\",\"text\":\"Birth Defects\"},{\"key\":\"other\",\"text\":\"Other (Specify)\"}],\"v_required\":{\"value\":\"true\",\"err\":\"Kindly select at least one birth complication\"},\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"baby_complications_other\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"Specify\",\"relevance\":{\"step3:baby_complications\":{\"ex-checkbox\":[{\"or\":[\"other\"]}]}}},{\"key\":\"baby_care_mgt\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"check_box\",\"label\":\"Newborn Routine Care & Management\",\"combine_checkbox_option_values\":\"true\",\"options\":[{\"key\":\"kmc\",\"text\":\"Kangaroo Mother Care(KMC)\"},{\"key\":\"antibiotics\",\"text\":\"Antibiotics\"},{\"key\":\"tetracycline_eye_ointment(TEO)\",\"text\":\"Tetracycline Eye Ointment (TEO)\"},{\"key\":\"chlorhexidine\",\"text\":\"Chlorhexidine (7.1%)\"},{\"key\":\"vitamin_k\",\"text\":\"Vitamin K\"},{\"key\":\"rescuscitation\",\"text\":\"Rescuscitation\"},{\"key\":\"referral\",\"text\":\"Referral\"},{\"key\":\"other\",\"text\":\"Other (Specify)\"}],\"relevance\":{\"step3:baby_complications\":{\"type\":\"string\",\"ex\":\"notEqualTo(., \\\"None\\\")\"}}},{\"key\":\"baby_intervention_specify\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"Specify\",\"relevance\":{\"step3:baby_care_mgt\":{\"ex-checkbox\":[{\"or\":[\"other\"]}]}}},{\"key\":\"baby_intervention_referral_location\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Specify the location of the referral\",\"values\":[\"The Nursery\",\"Other Facility\"],\"keys\":[\"The Nursery\",\"Other Facility\"],\"v_required\":{\"value\":\"true\",\"err\":\"Kindly select the referral location\"},\"relevance\":{\"rules-engine\":{\"ex-rules\":{\"rules-dynamic\":\"maternity/outcome_relevance_rules.yml\"}}}},{\"key\":\"newborn_survival_and_hiv_mgmt_label\",\"type\":\"label\",\"text\":\"Newborn Survival and HIV Management\",\"has_bg\":false,\"top_padding\":\"10dp\",\"left_padding\":\"20dp\",\"right_padding\":\"20dp\",\"text_size\":\"14sp\",\"text_color\":\"#000000\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"bf_first_hour\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Breastfeeding initiated within 60 mins\",\"values\":[\"Yes\",\"No\"],\"keys\":[\"Yes\",\"No\"],\"relevance\":{\"step3:discharged_alive\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Yes\\\")\"}}},{\"key\":\"child_hiv_status\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"spinner\",\"hint\":\"HIV Status of the Child\",\"values\":[\"Positive\",\"Negative\",\"Unknown\",\"Exposed\"],\"openmrs_choice_ids\":{\"Positive\":\"703AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Negative\":\"664AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Unknown\":\"1067AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Exposed\":\"822AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"}},{\"key\":\"nvp_administration\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"NVP Administration Started\",\"values\":[\"Yes\",\"No\"],\"keys\":[\"Yes\",\"No\"],\"relevance\":{\"rules-engine\":{\"ex-rules\":{\"rules-dynamic\":\"maternity/outcome_relevance_rules.yml\"}}}}]}]},\"step4\":{\"title\":\"Still born babies\",\"next\":\"step5\",\"fields\":[{\"key\":\"babies_stillborn\",\"type\":\"repeating_group\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"reference_edit_text_hint\":\"#Total stillborn babies\",\"repeating_group_label\":\"Baby Stillbirth Details\",\"reference_edit_text\":\"Number of babies stillborn\",\"value\":[{\"key\":\"stillbirth_condition\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"159917AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"spinner\",\"hint\":\"Stillbirth condition\",\"values\":[\"Fresh\",\"Macerated\",\"Other\"],\"openmrs_choice_ids\":{\"Fresh\":\"159916AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Macerated\":\"135436AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Other\":\"5622AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"v_required\":{\"value\":\"true\",\"err\":\"Select the condition of the Stillbirth\"}}]}]},\"step5\":{\"title\":\"Mother Information\",\"fields\":[{\"key\":\"mother_status\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Current mother's status\",\"values\":[\"Alive\",\"Brought in Dead(BID)\",\"Died Before Discharge(DBD\"],\"keys\":[\"Alive\",\"Brought in Dead(BID)\",\"Died Before Discharge(DBD\"],\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the Mother's status\"}},{\"key\":\"obstetric_complications\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"1541AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"check_box\",\"label\":\"Obstetric Complications\",\"combine_checkbox_option_values\":\"true\",\"exclusive\":[\"none\"],\"options\":[{\"key\":\"none\",\"text\":\"None\"},{\"key\":\"abnormal_presentation\",\"text\":\"Abnormal presentation\"},{\"key\":\"anterpartum_haemorrhage\",\"text\":\"Antepartum haemorrhage\"},{\"key\":\"cord_prolapse\",\"text\":\"Cord prolapse\"},{\"key\":\"eclampsia\",\"text\":\"Eclampsia\"},{\"key\":\"fetal_distress\",\"text\":\"Fetal distress\"},{\"key\":\"haemorrhage\",\"text\":\"Haemorrhage\"},{\"key\":\"obstructed_prolonged_labour\",\"text\":\"Obstructed/Prolonged Labour\"},{\"key\":\"perineal_tear\",\"text\":\"Perineal tear (2nd, 3rd, or 4th degree)\"},{\"key\":\"placenta_praevia\",\"text\":\"Placenta praevia\"},{\"key\":\"placental_abruption\",\"text\":\"Placental abruption\"},{\"key\":\"postpartum_haemorhage\",\"text\":\"Postpartum Haemorhage\"},{\"key\":\"pre_eclampsia\",\"text\":\"Pre-eclampsia\"},{\"key\":\"premature_labour\",\"text\":\"Premature labour\"},{\"key\":\"retained_placenta\",\"text\":\"Retained placenta\"},{\"key\":\"ruptured_uterus\",\"text\":\"Ruptured Uterus\"},{\"key\":\"sepsis\",\"text\":\"Sepsis\"},{\"key\":\"severe_anaemia\",\"text\":\"Severe Anaemia\"},{\"key\":\"symphysiotomy\",\"text\":\"Symphysiotomy\"},{\"key\":\"other\",\"text\":\"Other (Specify)\"}],\"relevance\":{\"step5:mother_status\":{\"type\":\"string\",\"ex\":\"equalTo(.,\\\"Alive\\\")\"}}},{\"key\":\"obstetric_complications_other\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"Specify\",\"relevance\":{\"step5:obstetric_complications\":{\"ex-checkbox\":[{\"or\":[\"other\"]}]}}},{\"key\":\"obstetric_care\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"160427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"check_box\",\"label\":\"Obstetric care\",\"combine_checkbox_option_values\":\"true\",\"exclusive\":[\"none\"],\"options\":[{\"key\":\"none\",\"text\":\"None\"},{\"key\":\"oxytocin\",\"text\":\"Oxytocin\"},{\"key\":\"anticonvulsants\",\"text\":\"Anticonvulsants\"},{\"key\":\"antibiotics\",\"text\":\"Antibiotics\"},{\"key\":\"antenatal_corticosteroids_dose_1\",\"text\":\"Antenatal corticosteroids (Dose 1)\"},{\"key\":\"antenatal_corticosteroids_dose_2\",\"text\":\"Antenatal corticosteroids (Dose 2)\"},{\"key\":\"blood_transfusion\",\"text\":\"Blood transfusion\"},{\"key\":\"mrp\",\"text\":\"Manual removal of placenta (MRP)\"},{\"key\":\"nasg\",\"text\":\"Non-pneumatic anti shock garment (NASG)\"},{\"key\":\"rpoc\",\"text\":\"Removal of retained products of conception (RPOC)\"},{\"key\":\"misoprostol_cytotec\",\"text\":\"Misoprostol/cytotec\"},{\"key\":\"other\",\"text\":\"Other (Specify)\"}]},{\"key\":\"obstetric_care_other\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"edit_text\",\"hint\":\"Specify\",\"relevance\":{\"step5:obstetric_care\":{\"ex-checkbox\":[{\"or\":[\"other\"]}]}}},{\"key\":\"referred_out\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Was the woman referred out?\",\"values\":[\"Yes\",\"No\"],\"keys\":[\"Yes\",\"No\"],\"relevance\":{\"step5:obstetric_care\":{\"ex-checkbox\":[{\"not\":[\"none\"]}]}}},{\"key\":\"vit_a\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"Was Vitamin A given to the woman?\",\"values\":[\"Yes\",\"No\"],\"keys\":[\"Yes\",\"No\"],\"relevance\":{\"step5:mother_status\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Alive\\\")\"}}},{\"key\":\"itn_given\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"160427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"native_radio\",\"label\":\"Insecticide Treated Net (ITN) given\",\"label_info_text\":\"\",\"label_info_title\":\"Insecticide Treated Net (ITN) given\",\"label_text_style\":\"bold\",\"options\":[{\"key\":\"yes\",\"text\":\"Yes\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"1066AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},{\"key\":\"no\",\"text\":\"No\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"1065AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"}]},{\"key\":\"discharge_status\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"spinner\",\"hint\":\"What is the discharge status for the woman?\",\"values\":[\"Discharged\",\"Absconded Visit\",\"Request for discharge\",\"Left against medical advice\",\"Lost to Followup\",\"Other\"],\"keys\":[\"Discharged\",\"Absconded Visit\",\"Request for discharge\",\"Left against medical advice\",\"Lost to Followup\",\"Other\"],\"relevance\":{\"step5:mother_status\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Alive\\\")\"}}}]}}";

    private String childEnrollmentForm = "{\"count\":\"1\",\"encounter_type\":\"Birth Registration\",\"mother\":{\"encounter_type\":\"New Woman Registration\"},\"entity_id\":\"\",\"relational_id\":\"\",\"step1\":{\"title\":\"Birth Registration\",\"fields\":[{\"key\":\"Child_Photo\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"type\":\"choose_image\",\"uploadButtonText\":\"Take a photo of the child\"},{\"key\":\"Home_Facility\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"\",\"openmrs_entity_id\":\"\",\"openmrs_data_type\":\"text\",\"type\":\"tree\",\"hint\":\"Child's home health facility \",\"tree\":[],\"v_required\":{\"value\":true,\"err\":\"Please enter the child's home facility\"}},{\"key\":\"ZEIR_ID\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person_identifier\",\"openmrs_entity_id\":\"ZEIR_ID\",\"type\":\"barcode\",\"render_type\":\"ID\",\"barcode_type\":\"qrcode\",\"hint\":\"Child's ZEIR ID \",\"scanButtonText\":\"Scan QR Code\",\"value\":\"0\",\"v_numeric\":{\"value\":\"true\",\"err\":\"Please enter a valid ID\"},\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the Child's ZEIR ID\"}},{\"key\":\"first_name\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person\",\"openmrs_entity_id\":\"first_name\",\"type\":\"edit_text\",\"hint\":\"First name\",\"edit_type\":\"name\"},{\"key\":\"last_name\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person\",\"openmrs_entity_id\":\"last_name\",\"type\":\"edit_text\",\"hint\":\"Last name \",\"edit_type\":\"name\",\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the last name\"}},{\"key\":\"Sex\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person\",\"openmrs_entity_id\":\"gender\",\"type\":\"spinner\",\"hint\":\"Sex \",\"values\":[\"Male\",\"Female\"],\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the sex\"}},{\"key\":\"Date_Birth\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person\",\"openmrs_entity_id\":\"birthdate\",\"type\":\"date_picker\",\"hint\":\"Child's DOB \",\"expanded\":false,\"duration\":{\"label\":\"Age\"},\"min_date\":\"today-5y\",\"max_date\":\"today\",\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the date of birth\"}},{\"key\":\"First_Health_Facility_Contact\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"163260AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"openmrs_data_type\":\"date\",\"type\":\"date_picker\",\"hint\":\"Date first seen \",\"expanded\":false,\"min_date\":\"today-5y\",\"max_date\":\"today\",\"v_required\":{\"value\":\"true\",\"err\":\"Enter the date that the child was first seen at a health facility for immunization services\"},\"constraints\":[{\"type\":\"date\",\"ex\":\"greaterThanEqualTo(., step1:Date_Birth)\",\"err\":\"Date first seen can't occur before date of birth\"}]},{\"key\":\"Birth_Weight\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"5916AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"openmrs_data_type\":\"text\",\"type\":\"edit_text\",\"hint\":\"Birth weight (kg) \",\"v_min\":{\"value\":\"0.1\",\"err\":\"Weight must be greater than 0\"},\"v_numeric\":{\"value\":\"true\",\"err\":\"Enter a valid weight\"},\"v_required\":{\"value\":\"true\",\"err\":\"Enter the child's birth weight\"}},{\"key\":\"Birth_Height\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"5916AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"openmrs_data_type\":\"text\",\"type\":\"edit_text\",\"hint\":\"Birth Height (cm)\",\"v_min\":{\"value\":\"0.1\",\"err\":\"Height must be greater than 0\"},\"v_numeric\":{\"value\":\"true\",\"err\":\"Enter a valid height\"},\"v_required\":{\"value\":\"true\",\"err\":\"Enter the child's birth height\"}},{\"key\":\"Mother_Guardian_First_Name\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person\",\"openmrs_entity_id\":\"first_name\",\"entity_id\":\"mother\",\"type\":\"edit_text\",\"hint\":\"Mother/guardian first name \",\"edit_type\":\"name\",\"look_up\":\"true\",\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the mother/guardian's first name\"}},{\"key\":\"Mother_Guardian_Last_Name\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person\",\"openmrs_entity_id\":\"last_name\",\"entity_id\":\"mother\",\"type\":\"edit_text\",\"hint\":\"Mother/guardian last name \",\"edit_type\":\"name\",\"look_up\":\"true\",\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the mother/guardian's last name\"}},{\"key\":\"Mother_Guardian_Date_Birth\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person\",\"openmrs_entity_id\":\"birthdate\",\"entity_id\":\"mother\",\"type\":\"date_picker\",\"hint\":\"Mother/Guardian DOB\",\"look_up\":\"true\",\"expanded\":false,\"duration\":{\"label\":\"Age\"},\"min_date\":\"01-01-1900\",\"max_date\":\"today-10y\",\"v_required\":{\"value\":\"true\",\"err\":\"Please enter the mother/guardian's DOB\"},\"relevance\":{\"rules-engine\":{\"ex-rules\":{\"rules-file\":\"child-enrollment-relevance.yml\"}}}},{\"key\":\"Mother_Guardian_Date_Birth_Unknown\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person\",\"openmrs_entity_id\":\"birthdateApprox\",\"entity_id\":\"mother\",\"look_up\":\"true\",\"type\":\"check_box\",\"label\":\"\",\"options\":[{\"key\":\"Mother_Guardian_Date_Birth_Unknown\",\"text\":\"DOB unknown?\",\"text_size\":\"18px\",\"value\":\"false\"}]},{\"key\":\"Mother_Guardian_Age\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person_attribute\",\"openmrs_entity_id\":\"mother_age\",\"entity_id\":\"mother\",\"type\":\"edit_text\",\"hint\":\"Mother/Guardian Age\",\"v_numeric\":{\"value\":\"true\",\"err\":\"Please enter a number\"},\"v_min\":{\"value\":\"0\",\"err\":\"Age must be equal or greater than 0\"},\"v_max\":{\"value\":\"99\",\"err\":\"Age must be equal or less than 99\"},\"relevance\":{\"rules-engine\":{\"ex-rules\":{\"rules-file\":\"child-enrollment-relevance.yml\"}}},\"v_required\":{\"value\":true,\"err\":\"Please enter the age\"}},{\"key\":\"Mother_Guardian_NRC\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"person_attribute\",\"openmrs_entity_id\":\"NRC_Number\",\"entity_id\":\"mother\",\"look_up\":\"true\",\"type\":\"edit_text\",\"hint\":\"Mother/guardian NRC number\"},{\"key\":\"Mother_Guardian_Phone_Number\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"159635AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"entity_id\":\"mother\",\"look_up\":\"true\",\"type\":\"edit_text\",\"hint\":\"Mother/guardian phone number\",\"v_numeric\":{\"value\":\"true\",\"err\":\"Number must begin with 095, 096, or 097 and must be a total of 10 digits in length\"}},{\"key\":\"Place_Birth\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"1572AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"openmrs_data_type\":\"select one\",\"type\":\"spinner\",\"entity_id\":\"mother\",\"look_up\":\"true\",\"hint\":\"Place of birth \",\"values\":[\"Health facility\",\"Home\"],\"openmrs_choice_ids\":{\"Health facility\":\"1588AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"Home\":\"1536AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"},\"v_required\":{\"value\":true,\"err\":\"Please enter the place of birth\"}},{\"key\":\"Birth_Facility_Name\",\"openmrs_entity_parent\":\"\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"163531AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"openmrs_data_type\":\"text\",\"type\":\"tree\",\"entity_id\":\"mother\",\"look_up\":\"true\",\"hint\":\"Which health facility was the child born in? \",\"tree\":[],\"v_required\":{\"value\":true,\"err\":\"Please enter the birth facility name\"},\"relevance\":{\"step1:Place_Birth\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"Health facility\\\")\"}}},{\"key\":\"Birth_Facility_Name_Other\",\"openmrs_entity_parent\":\"163531AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"openmrs_entity\":\"concept\",\"openmrs_entity_id\":\"160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"type\":\"edit_text\",\"hint\":\"Other health facility \",\"edit_type\":\"name\",\"v_required\":{\"value\":true,\"err\":\"Please specify the health facility the child was born in\"},\"relevance\":{\"step1:Birth_Facility_Name\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"[\\\"Other\\\"]\\\")\"}}},{\"key\":\"Residential_Area_Other\",\"openmrs_entity_parent\":\"usual_residence\",\"openmrs_entity\":\"person_address\",\"openmrs_entity_id\":\"address5\",\"type\":\"edit_text\",\"hint\":\"Other residential area \",\"edit_type\":\"name\",\"v_required\":{\"value\":true,\"err\":\"Please specify the residential area\"},\"relevance\":{\"step1:Residential_Area\":{\"type\":\"string\",\"ex\":\"equalTo(., \\\"[\\\"Other\\\"]\\\")\"}}},{\"key\":\"Residential_Address\",\"openmrs_entity_parent\":\"usual_residence\",\"openmrs_entity\":\"person_address\",\"openmrs_entity_id\":\"address2\",\"type\":\"edit_text\",\"hint\":\"Home address \",\"edit_type\":\"name\",\"v_required\":{\"value\":true,\"err\":\"Please enter the home address\"}}]}}";

    @Mock
    private MaternityLibrary maternityLibrary;

    @Mock
    private CoreLibrary coreLibrary;

    private GizMaternityOutcomeFormProcessing maternityOutcomeFormProcessing;

    private String baseEntityId = "2323-sdwe34-323";

    @Mock
    private AllSharedPreferences allSharedPreferences;

    @Mock
    private Context opensrpContext;

    @Before
    public void setUp() {
        maternityOutcomeFormProcessing = new GizMaternityOutcomeFormProcessing();
        MockitoAnnotations.initMocks(this);
    }

    @Test
    public void testProcessMaternityFormShouldCreateTwoEvents() throws JSONException {
        AppExecutors appExecutors = new AppExecutors();
        Mockito.when(allSharedPreferences.fetchRegisteredANM()).thenReturn("demo");
        Mockito.when(opensrpContext.allSharedPreferences()).thenReturn(allSharedPreferences);
        Mockito.when(coreLibrary.context()).thenReturn(opensrpContext);
        Mockito.when(maternityLibrary.getAppExecutors()).thenReturn(appExecutors);
        ReflectionHelpers.setStaticField(CoreLibrary.class, "instance", coreLibrary);
        ReflectionHelpers.setStaticField(MaternityLibrary.class, "instance", maternityLibrary);
        Intent intent = new Intent();
        intent.putExtra(MaternityConstants.IntentKey.BASE_ENTITY_ID, baseEntityId);
        List<Event> eventList = maternityOutcomeFormProcessing.processMaternityForm(outcomeForm, intent);
        Assert.assertEquals(2, eventList.size());
        Assert.assertEquals(eventList.get(0).getEventType(), MaternityConstants.EventType.MATERNITY_OUTCOME);
        Assert.assertEquals(eventList.get(1).getEventType(), MaternityConstants.EventType.MATERNITY_CLOSE);
        Assert.assertNotNull(eventList.get(1).getDetails().get(MaternityConstants.JSON_FORM_KEY.VISIT_END_DATE));

        for (Event event : eventList) {
            Assert.assertEquals(baseEntityId, event.getBaseEntityId());
        }
    }

    @Test
    public void testBuildChildRegistrationEventsWithDischargedAliveFalseShouldNotCreateEvent() throws Exception {
        MaternityOutcomeFormProcessingTask spyMaternityOutcomeFormProcessingTask = Mockito.spy(maternityOutcomeFormProcessing);
        Mockito.when(allSharedPreferences.fetchRegisteredANM()).thenReturn("demo");
        Mockito.when(opensrpContext.allSharedPreferences()).thenReturn(allSharedPreferences);
        Mockito.when(coreLibrary.context()).thenReturn(opensrpContext);
        ReflectionHelpers.setStaticField(CoreLibrary.class, "instance", coreLibrary);
        ReflectionHelpers.setStaticField(MaternityLibrary.class, "instance", maternityLibrary);
        HashMap<String, String> hashMap = new HashMap<>();
        hashMap.put("baby_first_name", "John");
        hashMap.put("baby_last_name", "Doe");
        Mockito.doReturn(new HashMap<>()).when(spyMaternityOutcomeFormProcessingTask).motherDetails(baseEntityId);
        HashMap<String, HashMap<String, String>> buildRepeatingGroupBorn = new HashMap<>();
        buildRepeatingGroupBorn.put("2323-sdsd32", hashMap);
        JSONObject childForm = new JSONObject(childEnrollmentForm);
        List<MaternityEventClient> childRegEventList = Whitebox.invokeMethod(spyMaternityOutcomeFormProcessingTask, "buildChildRegistrationEvents", buildRepeatingGroupBorn, baseEntityId, childForm);
        Assert.assertTrue(childRegEventList.isEmpty());
    }

    @Test
    public void testBuildChildRegistrationEventsWithDischargedAliveTrueShouldCreateEvent() throws Exception {
        MaternityOutcomeFormProcessingTask spyMaternityOutcomeFormProcessingTask = Mockito.spy(maternityOutcomeFormProcessing);
        Mockito.when(allSharedPreferences.fetchRegisteredANM()).thenReturn("demo");
        Mockito.when(opensrpContext.allSharedPreferences()).thenReturn(allSharedPreferences);
        Mockito.when(coreLibrary.context()).thenReturn(opensrpContext);
        UniqueIdRepository uniqueIdRepository = Mockito.mock(UniqueIdRepository.class);
        UniqueId uniqueId = new UniqueId();
        uniqueId.setOpenmrsId("34323");
        Mockito.when(uniqueIdRepository.getNextUniqueId()).thenReturn(uniqueId);
        Mockito.when(maternityLibrary.getUniqueIdRepository()).thenReturn(uniqueIdRepository);
        ReflectionHelpers.setStaticField(CoreLibrary.class, "instance", coreLibrary);
        ReflectionHelpers.setStaticField(MaternityLibrary.class, "instance", maternityLibrary);
        HashMap<String, String> hashMap = new HashMap<>();
        hashMap.put("baby_first_name", "John");
        hashMap.put("baby_last_name", "Doe");
        hashMap.put(MaternityConstants.JSON_FORM_KEY.DISCHARGED_ALIVE, "yes");
        JSONObject childForm = new JSONObject(childEnrollmentForm);
        Mockito.doReturn(FormUtils.getMultiStepFormFields(childForm)).when(spyMaternityOutcomeFormProcessingTask).getChildFormFields();
        Mockito.doReturn(new HashMap<>()).when(spyMaternityOutcomeFormProcessingTask).motherDetails(baseEntityId);
        HashMap<String, HashMap<String, String>> buildRepeatingGroupBorn = new HashMap<>();
        buildRepeatingGroupBorn.put("2323-sdsd32", hashMap);
        JSONObject outcomeFormJsonObject = new JSONObject(outcomeForm);
        List<MaternityEventClient> childRegEventList = Whitebox.invokeMethod(spyMaternityOutcomeFormProcessingTask, "buildChildRegistrationEvents", buildRepeatingGroupBorn, baseEntityId, outcomeFormJsonObject);
        Assert.assertEquals(1, childRegEventList.size());
        Assert.assertEquals(MaternityConstants.EventType.BIRTH_REGISTRATION, childRegEventList.get(0).getEvent().getEventType());
        Assert.assertNotNull(childRegEventList.get(0).getClient());
    }

    @After
    public void tearDown() {
        ReflectionHelpers.setStaticField(MaternityLibrary.class, "instance", null);
        ReflectionHelpers.setStaticField(CoreLibrary.class, "instance", null);
    }
}